---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(viridis)
library(sugrrants)
library(lubridate)
library(ggmap)
library(leaflet)
```

# Read data

```{r read-data}
weather <- read.csv("data/weather.csv")
locations <- read.csv("data/locations.csv")
```

# Data checking

```{r check-collection-all}
weather %>% group_by(site_id, local_date) %>% 
  tally() %>% 
  ggplot(aes(x = local_date,
             y = n)) + 
  geom_col() +
  facet_wrap(~ site_id, ncol = 3)
```

```{r check-collection-all}
weather %>% filter(minute == 0) %>% 
  group_by(site_id, local_date) %>% 
  tally() %>% 
  ggplot(aes(x = local_date,
             y = n)) + 
  geom_col() +
  facet_wrap(~ site_id, ncol = 3)
```

```{r}
weather_tidy <- weather %>% 
  mutate(local_date = as.Date(local_date),
         time = case_when(
           minute == 0 ~ paste0(hour,".0"),
           minute == 15 ~ paste0(hour,".25"),
           minute == 30 ~ paste0(hour,".5"),
           minute == 45 ~ paste0(hour,".75")),
         time = as.double(time),
         site_id = as.character(site_id),
         month = month(local_date),
         datetime = make_datetime(year = year, 
                                  month = month, 
                                  day = day, 
                                  hour = hour, 
                                  min = minute,
                                  sec = 0, 
                                  tz = "Australia/Melbourne"))%>% 
  filter(!is.na(relative_humidity_percent))

# class(weather$local_date)
# class(weather_time$time)
# class(weather$hour)
# class(weather_tidy$month)
class(weather_tidy$local_date)
# class(weather$ambient_temperature_celsius)
```

# Map
```{r ggmap}
area <- c(left = 144.95, 
          bottom = -37.83, 
          right = 144.98, 
          top = -37.80)

map <- get_map(location = area, 
                source = "osm", 
                maptype = "toner") 

p_map <- ggmap(map) + 
  geom_point(data = locations,
             aes(x = longitude,
                 y = latitude,
                 color = site_id)) 

p_map

```

```{r leaflets}
p_leaflet <- leaflet(locations) %>% 
  addTiles() %>% 
  addCircleMarkers(lat = ~latitude, 
                   lng = ~longitude,
                   popup =
                     paste0("Site id:",locations$site_id,
                            "<br/>", "Longitude:",locations$longitude,
                            "<br/>", "Latitude:",locations$latitude,
                            "<br/>", "See relative humidity change"))
p_leaflet
```


# Daily humidity change

# Humidity percent

### Site 1007

```{r 1007-by-month}
weather_tidy %>% 
  filter(site_id == 1007) %>% 
  ggplot() +
  geom_line(aes(x = time,
                y = relative_humidity_percent,
                group = local_date)) +
  geom_hline(yintercept = 60, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 30, color = "red", linetype = "dashed") +
  geom_smooth(aes(x = time,
                  y = relative_humidity_percent),
              se = FALSE) +
  facet_wrap(~ month, ncol = 3)+
  labs(x = "Time",
       y = "Humidity percent")
```

### Site comparision

```{r by-site}
weather_tidy %>% 
  ggplot() +
  geom_line(aes(x = time,
                y = relative_humidity_percent,
                group = local_date,
                color = site_id)) +
  scale_x_continuous(breaks = seq(0, 24, 6))+
  geom_hline(yintercept = 60, color = "red", linetype = "dashed") +
  geom_hline(yintercept = 30, color = "red", linetype = "dashed") +
  geom_smooth(aes(x = time,
                  y = relative_humidity_percent),
              se = FALSE) +
  facet_grid(month ~ site_id) +
  scale_color_brewer(palette = "Dark2") +
  theme(legend.position = "none") +
  labs(x = "Time",
       y = "Humidity percent")
```


## What time humidity >=60 or <=30 happen often?

### Site 1007

```{r humidity>=60}
weather_tidy %>% 
  filter(site_id == 1007,
         relative_humidity_percent >= 60) %>% 
  group_by(month, time) %>% 
  tally() %>% 
  ggplot(aes(x = time,
             y = n)) + 
  geom_col() +
  facet_wrap(~ month, ncol = 3) +
  labs(y = "the num of catached humidity data")
```

```{r humidity>=60-percent}
site <- weather_tidy %>% 
  filter(site_id == 1007) %>% 
  group_by(month, time) %>% 
  tally() 

perc60 <- weather_tidy %>% 
  filter(site_id == 1007,
         relative_humidity_percent >= 60) %>% 
  group_by(month, time) %>% 
  summarise(n_60 = n())

left_join(perc60, site) %>% 
  mutate(perc60 = round(n_60/n,2)*100)%>% 
  ggplot(aes(x = time,
             y = perc60)) + 
  geom_col() +
  facet_wrap(~ month, ncol = 3)
```

```{r humidity<=30}
weather_tidy %>% 
  filter(site_id == 1007,
         relative_humidity_percent <= 30) %>% 
  group_by(month, time) %>% 
  tally() %>% 
  ggplot(aes(x = time,
             y = n)) + 
  geom_col() +
  facet_wrap(~ month, ncol = 3)
```

```{r humidity<=30-percent}
perc30 <- weather_tidy %>% 
  filter(site_id == 1007,
         relative_humidity_percent <= 30) %>% 
  group_by(month, time) %>% 
  summarise(n_30 = n())

left_join(perc30, site) %>% 
  mutate(perc30 = round(n_30/n,2)*100)%>% 
  ggplot(aes(x = time,
             y = perc30)) + 
  geom_col() +
  facet_wrap(~ month, ncol = 3)
```


# Seaonal/for several months

```{r}
weather_tidy %>%
  ggplot() +
  geom_line(aes(x = datetime,
                y = relative_humidity_percent,
                color = site_id)) +
  geom_smooth(aes(x = datetime,
                  y = relative_humidity_percent),
              se = FALSE) +
  # facet_wrap(~ site_id, ncol = 2, strip.position="right") +
  theme(legend.position = "none") +
  scale_color_brewer(palette = "Dark2")
  
```


```{r calendar-1007}
centre_calendar <- weather_tidy %>%
  filter(site_id == 1007) %>%
  frame_calendar(x = time, 
                 y = relative_humidity_percent, 
                 date = local_date, 
                 calendar = "monthly",
                 # scale = "free", 
                 ncol = 4)

p1 <- ggplot(centre_calendar) +
  geom_line(data  = centre_calendar,
            aes(x = .time,
                y = .relative_humidity_percent,
                group = local_date)) +
  geom_line(data = filter(centre_calendar,
                          (relative_humidity_percent >= 60 |
                             relative_humidity_percent <=30 )),
            aes(x = .time,
                y = .relative_humidity_percent,
                group = local_date,
                color = "red")) 
  # geom_line(aes(colour = site_id)) +
  # facet_grid(site_id ~ .) +
  # scale_color_brewer(palette = "Dark2") +
  # theme(legend.position = "bottom")
  
prettify(p1)
```
